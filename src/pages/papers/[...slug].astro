---
import PaperPost from '@/layouts/PaperPost.astro'
import PostTitle from "@/components/PostTitle.astro";
import BlogFooter from '@/components/BlogFooter.astro'
import {getCollectionByName} from "@/utils/getCollectionByName";
import {sortPostsByDate} from "@/utils/sortPostsByDate";
import getUrl from "@/utils/getUrl";

export async function getStaticPaths() {
  const entries = await getCollectionByName("papers");
  return entries.map(entry => ({ params: { slug: entry.slug }, props: { entry } }));
}

const {entry} = Astro.props;
const {Content, headings, remarkPluginFrontmatter} = await entry.render();

const lastModified = remarkPluginFrontmatter.lastModified
const readingTime = remarkPluginFrontmatter.readingTime

const posts = await getCollectionByName("papers");
const sortPosts = sortPostsByDate(posts);

const currentPostIndex = sortPosts.findIndex(
  (postItem) => postItem.data.title === entry.data.title
);
let prevPost, nextPost
if (sortPosts[currentPostIndex - 1]) {
  prevPost = sortPosts[currentPostIndex - 1];
}
if (sortPosts[currentPostIndex + 1]) {
  nextPost = sortPosts[currentPostIndex + 1];
}
---
<PaperPost frontmatter={entry.data} headings={headings}>
  <div>
    <PostTitle {...entry.data} lastModified={lastModified} readingTime={readingTime}></PostTitle>
    <div class="divider-horizontal"></div>
    <article class="markdown-body">
      <Content/>
    </article>
    <div class="divider-horizontal"></div>

    {
      entry.data.pdf ? (
        (() => {
          const pdfPath = (entry.data.pdf && entry.data.pdf.includes('/')) ? entry.data.pdf : (entry.slug + '/' + entry.data.pdf);
          const fullUrl = getUrl('/') + entry.collection + '/' + pdfPath;
          return (
            <div class="mt-6 p-4 border rounded bg-skin-card">
              <div class="flex items-center justify-between">
                <div class="font-semibold">Download / View PDF</div>
                <a class="text-sm underline" href={fullUrl} target="_blank" rel="noreferrer">Open in new tab</a>
              </div>
              <div class="mt-4">
                <iframe src={fullUrl} class="w-full h-96 border" title="PDF preview"></iframe>
              </div>
            </div>
          )
        })()
      ) : ''
    }

    <div class="h-8 text-skin-base">
      {
        prevPost ? (
          <a
            class="truncate  w-auto max-w-[40%] float-left"
            href={getUrl('/') + prevPost.collection + '/' + prevPost.slug}
            title={prevPost.data.title}
          >
            <i class="ri-arrow-left-s-fill"/>
            {prevPost.data.title}
          </a>
        ) : (
          <div/>
        )
      }
      {
        nextPost ? (
          <div class="flex item-center float-right w-auto max-w-[40%] text-right">
            <a class="truncate " href={getUrl('/') + nextPost.collection + '/' + nextPost.slug} title={nextPost.data.title}>
              {nextPost.data.title}
            </a>
            <i class="float-right ri-arrow-right-s-fill"/>
          </div>
        ) : (
          <div/>
        )
      }

</PaperPost>
