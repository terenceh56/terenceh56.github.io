---
import IndexPage from '@/layouts/IndexPage.astro';
import { t } from '@/i18n/utils';
---

<IndexPage>
  <aside>
    <div class="mb-6 p-4 glass rounded-lg shadow-md">
      <div class="flex items-center mb-3">
        <div
          class="mr-3 flex h-10 w-10 items-center justify-center rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500 text-white shadow-md"
        >
          <i class="ri-search-line text-xl"></i>
        </div>
        <div>
          <h1 class="text-2xl font-bold italic text-skin-base">
            {t('search.search')}
          </h1>
        </div>
      </div>

      <div class="relative mt-2">
        <span
          class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 opacity-75"
        >
          <i class="ri-search-line text-skin-active"></i>
        </span>
        <input
          required
          maxlength="24"
          id="search"
          class="block w-full rounded-xl border border-skin-line/60 bg-skin-fill/80 text-skin-base py-3 pl-10 pr-3 text-sm placeholder:italic placeholder:text-opacity-75 focus:border-skin-accent focus:outline-none focus:ring-2 focus:ring-skin-accent/60 transition-all"
          placeholder={t('search.placeholder')}
          type="search"
          name="search"
          autofocus
        />
      </div>
    </div>
  </aside>

  <section aria-label="Search Results">
    <div id="searchResults" class="hidden glass rounded-lg p-4 shadow-sm">
      <p id="searchReadout" class="mb-2 text-sm text-skin-base"></p>
      <div id="resultsList" class="mt-2"></div>
    </div>
  </section>
</IndexPage>
<script>
  import { t } from '../i18n/utils';
  import DOMPurify from 'dompurify';
  import Fuse from 'fuse.js';
  import { isNumber } from 'lodash-es';
  import { formatDate } from '../utils/formatDate';
  import { dealLabel } from '../utils/dealLabel';
  import getUrl from '../utils/getUrl';

  let SEARCH_DATA = '';
  let FUSE_INSTANCE = '';
  let FUSE_OPTIONS = {
    includeScore: true,
    shouldSort: true,
    threshold: 0.4,
    keys: [
      {
        name: 'title',
        weight: 1,
      },
    ],
  };
  let SPINNER = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="#000000" viewBox="0 0 256 256" id="spinner"><path d="M232,128a104,104,0,0,1-208,0c0-41,23.81-78.36,60.66-95.27a8,8,0,0,1,6.68,14.54C60.15,61.59,40,93.27,40,128a88,88,0,0,0,176,0c0-34.73-20.15-66.41-51.34-80.73a8,8,0,0,1,6.68-14.54C208.19,49.64,232,87,232,128Z"></path>
<style>
#spinner {
    animation: spin 1s linear infinite;
}
@keyframes spin {
    100% {
        transform: rotate(360deg);
    }
}
</style>
</svg>`;

  let searchInputEl = null;
  let searchReadoutEl = null;
  let resultsListEl = null;
  let searchResultsContainerEl = null;
  let teardownSearchListeners = null;

  const sanitizeTerm = (value) => DOMPurify.sanitize(value ?? '').trim();

  const escapeRegExp = (value) => value.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

  function initSearchUI() {
    teardownSearchListeners?.();
    searchInputEl = document.querySelector('#search');
    searchReadoutEl = document.querySelector('#searchReadout');
    resultsListEl = document.querySelector('#resultsList');
    searchResultsContainerEl = document.querySelector('#searchResults');

    if (!searchInputEl || !searchReadoutEl || !resultsListEl) {
      console.warn('Search UI elements missing.');
      return;
    }

    const handleInput = () => {
      const searchTerm = sanitizeTerm(searchInputEl.value);
      fetchSearchResults(searchTerm);
      updateSearchPageUrl(searchTerm);
    };

    searchInputEl.addEventListener('input', handleInput);

    const urlQuery = new URLSearchParams(window.location.search).get('q');
    const initialTerm = sanitizeTerm(urlQuery);
    searchInputEl.value = initialTerm;
    if (initialTerm) {
      fetchSearchResults(initialTerm);
    } else {
      updateReadout(null);
      resultsListEl.innerHTML = '';
      searchResultsContainerEl?.classList.add('hidden');
    }
    searchInputEl.focus();

    teardownSearchListeners = () => {
      searchInputEl?.removeEventListener('input', handleInput);
    };
  }

  const bootstrapSearch = () => {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSearchUI, {
        once: true,
      });
    } else {
      initSearchUI();
    }
  };

  bootstrapSearch();
  document.addEventListener('astro:page-load', initSearchUI);

  function updateReadout(length) {
    if (!searchReadoutEl) return;
    if (isNumber(length)) {
      searchReadoutEl.innerHTML = `<div class="my-2">${t('search.searchLabelOne')}<span class="px-2 font-bold text-skin-active">${length}</span>${t('search.searchLabelTwo')}</div>`;
    } else {
      searchReadoutEl.innerHTML = '';
    }
  }

  function updateSearchPageUrl(search) {
    const url = new URL(window.location.href);
    url.searchParams.set('q', search);
    window.history.replaceState(null, '', url);
  }

  function generateSearchList(results, searchTerm) {
    return results
      .map((r) => {
        const { title, description, date, slug, category, tags, collection } =
          r.item;
        const reg = new RegExp(escapeRegExp(searchTerm), 'gi');
        let titleStr = title.replace(reg, (match) => {
          return `<span class="text-skin-active font-bold">${match}</span>`;
        });
        let descriptionStr = description || '';

        let categoryStr = dealLabel(category)
          .filter((item) => item !== 'uncategorized')
          .map(
            (categoryName) =>
              `<a class="mr-2 hover:text-skin-active" href=${getUrl('/category/') + categoryName}><i class="ri-folder-3-line mr-1"></i>${categoryName}</a>`,
          )
          .join('');
        let tagsStr = dealLabel(tags)
          .map(
            (tagName) =>
              `<a class="mr-2 hover:text-skin-active" href=${getUrl('/tags/') + tagName}><i class="ri-hashtag mr-1"></i>${tagName}</a>`,
          )
          .join('');
        return `
        <div class="my-5">
            <a
              class="text-xl font-bold underline-offset-4 decoration-skin-base decoration-wavy cursor-pointer transition-all duration-300 hover:text-skin-active hover:translate-x-1"
              href=${getUrl('/') + collection + '/' + slug}>${titleStr}
            </a>
            <div class="flex items-center my-2">
              <div class="flex items-center mr-2"><i class="ri-calendar-2-fill mr-1"></i>${formatDate(date)}</div>
              ${categoryStr} ${tagsStr}
            </div>
            <p class="break-all mb-4">${descriptionStr}</p>
        </div>
        <div class="divider-horizontal-mini"></div>`;
      })
      .join('');
  }

  async function fetchSearchResults(search) {
    if (!resultsListEl) return;
    if (!search) {
      updateReadout(null);
      resultsListEl.innerHTML = '';
      searchResultsContainerEl?.classList.add('hidden');
      return;
    }
    if (search.length === 0) return;
    searchResultsContainerEl?.classList.remove('hidden');
    resultsListEl.innerHTML = SPINNER;
    if (!SEARCH_DATA) {
      try {
        const res = await fetch(getUrl('/search.json'));
        if (!res.ok) {
          throw new Error('Something went wrong...Please try again.');
        }
        SEARCH_DATA = await res.json();
      } catch (e) {
        console.log(e);
      }
    }
    if (SEARCH_DATA && !FUSE_INSTANCE) {
      FUSE_INSTANCE = new Fuse(SEARCH_DATA, FUSE_OPTIONS);
    }

    if (!FUSE_INSTANCE) return;
    const searchResults = FUSE_INSTANCE.search(search);
    updateReadout(searchResults.length);
    resultsListEl.innerHTML =
      searchResults.length > 0
        ? generateSearchList(searchResults, search)
        : '<p class="text-sm text-skin-dodge opacity-80">No matching titles found.</p>';
  }
</script>
