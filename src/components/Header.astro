---
import {getCollectionByName} from "@/utils/getCollectionByName";
import getUniqueTags from "@/utils/getUniqueTags";
import getCountByCategory from "@/utils/getCountByCategory";
import HeaderLink from './HeaderLink.astro';
import ThemeIcon from './ThemeIcon.astro'
import MenuIcon from './MenuIcon.astro'
import {site, categories, infoLinks} from '@/consts';
import AsideIcon from "./SidebarIcon.astro";
import {t} from "@/i18n/utils";
import getCountByTagName from "@/utils/getCountByTagName";
import getUrl from "@/utils/getUrl";
// aggregate posts from multiple collections so counts still work after removing the "blog" category
let posts = [];
const collectionsToTry = ['blog', 'notes', 'thoughts', 'papers', 'feed'];
for (const col of collectionsToTry) {
  try {
    const c = await getCollectionByName(col);
    if (c && c.length) posts = posts.concat(c);
  } catch (err) {
    // ignore missing collections
  }
}
let tagArr = getUniqueTags(posts);
let categoryCount = getCountByCategory(posts);
let tagCount = getCountByTagName(posts);
const { hideNav = false } = Astro.props;

---

<header data-home={getUrl('/')} class="fixed top-0 z-50 w-full glass text-skin-base h-14 flex grid place-items-center">
  <div class="w-full xl:container mx-auto flex items-center justify-between px-4 xl:px-4 h-12">
    <!-- Left: Menu button (mobile only) -->
    <div class="flex-shrink-0 xl:hidden">
      <MenuIcon></MenuIcon>
    </div>
    
    <!-- Center: Logo -->
    <a class="header-logo py-1 px-4 text-2xl flex items-center absolute left-1/2 transform -translate-x-1/2 xl:static xl:transform-none xl:left-auto" href={getUrl("/")}>
      <img src={getUrl(site.favicon)} alt={site.title} class="h-6 w-auto mr-3" />
      <span class="font-bold">{site.title}</span>
    </a>
    
    <!-- Right: Navigation + Theme button -->
    <div class="flex items-center flex-shrink-0">
      { !hideNav && (
        <div class="hidden xl:block">
          <div class="flex items-center pr-4 space-x-5">
            {
              categories.map(category => (
                <HeaderLink href={category.href} icon={category.iconClass} target={category.target ? category.target : '_self'} children={category.children ? category.children : []}>{category.name}</HeaderLink>
              ))
            }
          </div>
        </div>
      )}
      <ThemeIcon></ThemeIcon>
    </div>
  </div>
  { !hideNav && (
<div id="mobile-menu" class="closed pb-8 overflow-y-auto text-center">
    {
      categories.map((category) => (
        <div class="py-2">
          <a class=" hover:text-skin-active" href={getUrl(category.href)}>
            <i class={category.iconClass}/>
            <span>{category.name}</span>
          </a>
          {
            category.children && category.children.length > 0 &&
            <div class="divider-horizontal"></div>
          }
          <div class="space-y-4 text-sm">
            {
              category.children && category.children.map(sub =>
                (
                  <a class="block hover:text-skin-active" href={getUrl(sub.href)}>
                    <i class={sub.iconClass}/>
                    <span>{sub.name}</span>
                  </a>
                )
              )
            }
          </div>
        </div>
      ))
    }
    </div>
  )}
  { !hideNav && (
    <div id="personal-info" class="hidden pb-8 overflow-y-auto break-all">
    <img class="mx-auto my-4 avatar" src={getUrl(site.avatar)} alt="avatar"/>
    <div class="mb-2 text-center">{site.motto}</div>
    </div>

    </div>
  )}
</header>
  <!-- Backdrop blur overlay for mobile menu -->
  <div id="menu-backdrop" class="menu-backdrop"></div>

<script>
(function(){
    try {
        const header = document.querySelector('header');
        const homepage = header && header.dataset ? header.dataset.home || '/' : '/';
        
        // Header animation logic (keep your existing code)
        const fromHomepage = sessionStorage.getItem('fromHomepage');
        if (fromHomepage && header) {
            if (!header.classList.contains('header--drop') && !header.classList.contains('header--dropped')) {
                header.classList.add('header--drop');
                const ANIM_DURATION = 360 + 80;
                setTimeout(() => {
                    header.classList.remove('header--drop');
                    header.classList.add('header--dropped');
                }, ANIM_DURATION + 40);
            }
            sessionStorage.removeItem('fromHomepage');
        } else if (header) {
            header.classList.remove('header--drop');
            header.classList.remove('header--up');
            header.classList.add('header--dropped');
        }

        // Mobile menu functionality
        function closeMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const backdrop = document.getElementById('menu-backdrop');
            const header = document.querySelector('header');
            
            if (menu && menu.classList.contains('open')) {
                // Start closing animation
                menu.classList.remove('open');
                menu.classList.add('closing');
                backdrop?.classList.remove('active');
                header?.classList.remove('menu-open');
                
                // Remove closing class after animation completes
                setTimeout(() => {
                    menu.classList.remove('closing');
                    menu.classList.add('closed');
                }, 300);
            }
        }

        function openMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            const personalInfo = document.getElementById('personal-info');
            const backdrop = document.getElementById('menu-backdrop');
            const header = document.querySelector('header');

            // Close personal info if open
            if (personalInfo && !personalInfo.classList.contains('hidden')) {
                personalInfo.classList.add('closing');
                setTimeout(() => {
                    personalInfo.classList.add('hidden');
                    personalInfo.classList.remove('closing');
                }, 250);
            }
            
            // Open mobile menu
            menu.classList.remove('closed', 'closing');
            menu.classList.add('open');
            backdrop?.classList.add('active');
            header?.classList.add('menu-open');
        }

        function isMenuOpen() {
            const menu = document.getElementById('mobile-menu');
            return menu && menu.classList.contains('open');
        }

        // Main click handler
        document.addEventListener('click', function(e){
            const target = e.target;
            const a = target.closest('a');
            const menuToggleBtn = target.closest('#menu-toggle-btn');
            const asideBtn = target.closest('#aside-btn');
            const asideCloseBtn = target.closest('#aside-close-btn');
            const backdrop = target.closest('#menu-backdrop');

            // Backdrop click - close menu
            if (backdrop && isMenuOpen()) {
                closeMobileMenu();
                return;
            }

            // Menu toggle button
            if (menuToggleBtn) {
                if (isMenuOpen()) {
                    closeMobileMenu();
                } else {
                    openMobileMenu();
                }
                e.preventDefault();
                return;
            }

            // Aside button
            if (asideBtn) {
                const menu = document.getElementById('mobile-menu');
                const personalInfo = document.getElementById('personal-info');
                const showAsideBtn = document.getElementById('aside-btn');
                const closeAsideBtn = document.getElementById('aside-close-btn');
                
                // Close menu if open
                if (menu && isMenuOpen()) {
                    closeMobileMenu();
                }
                
                // Open personal info
                personalInfo.classList.remove('hidden', 'closing');
                showAsideBtn.classList.add('hidden');
                closeAsideBtn.classList.remove('hidden');
                e.preventDefault();
                return;
            }

            // Aside close button
            if (asideCloseBtn) {
                const personalInfo = document.getElementById('personal-info');
                const showAsideBtn = document.getElementById('aside-btn');
                const closeAsideBtn = document.getElementById('aside-close-btn');
                
                // Close personal info
                personalInfo.classList.add('closing');
                showAsideBtn.classList.remove('hidden');
                closeAsideBtn.classList.add('hidden');
                setTimeout(() => {
                    personalInfo.classList.add('hidden');
                    personalInfo.classList.remove('closing');
                }, 250);
                e.preventDefault();
                return;
            }

            // Close menu when clicking on menu links (optional)
            if (a && a.closest('#mobile-menu') && isMenuOpen()) {
                setTimeout(closeMobileMenu, 200);
            }

            // Homepage link animation
            if(!a) return;
            const href = a.getAttribute('href');
            if(!href) return;
            const currentPath = window.location.pathname;
            const isHomepage = currentPath === '/' || currentPath === homepage;

            if (href === '/' || href === '' || href === homepage) {
                e.preventDefault();
                if (header && !header.classList.contains('header--up')) {
                    header.classList.add('header--up');
                    header.classList.remove('header--dropped');
                }
                setTimeout(function(){ window.location.href = href; }, 280);
            } else if (isHomepage) {
                sessionStorage.setItem('fromHomepage', 'true');
            }
        });

        // Close menu on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && isMenuOpen()) {
                closeMobileMenu();
            }
        });

        // Close menu when touching outside on mobile
        document.addEventListener('touchstart', function(e) {
            const menu = document.getElementById('mobile-menu');
            const backdrop = document.getElementById('menu-backdrop');
            
            if (isMenuOpen() && 
                !menu.contains(e.target) && 
                !backdrop.contains(e.target) &&
                !e.target.closest('#menu-toggle-btn')) {
                closeMobileMenu();
            }
        });

        // Glassmorphic blur effect
        const currentPath = window.location.pathname;
        const isHomepage = currentPath === '/' || currentPath === homepage;
        
        if (!isHomepage && header) {
            let ticking = false;
            const SCROLL_THRESHOLD = 50;

            function updateGlassEffect() {
                const scrollY = window.scrollY || window.pageYOffset;
                if (scrollY > SCROLL_THRESHOLD) {
                    header.classList.add('glass--active');
                } else {
                    header.classList.remove('glass--active');
                }
                ticking = false;
            }

            function onScroll() {
                if (!ticking) {
                    window.requestAnimationFrame(updateGlassEffect);
                    ticking = true;
                }
            }

            updateGlassEffect();
            window.addEventListener('scroll', onScroll, { passive: true });
        }
    } catch (err) { 
        console.error(err); 
    }
})();
</script>
