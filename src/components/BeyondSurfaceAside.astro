---
import { getCollectionByName } from '@/utils/getCollectionByName';
import getUniqueTags from '@/utils/getUniqueTags';
import { sortPostsByDate } from '@/utils/sortPostsByDate';
import { site } from '@/consts';
import { t } from '@/i18n/utils';
import getUrl from '@/utils/getUrl';
import getCountByTagName from '@/utils/getCountByTagName';

// Aggregate posts from Beyond the Surface collections ONLY
let allPosts = [];
const collectionsToTry = ['reflections', 'milestones'];
for (const col of collectionsToTry) {
  try {
    const c = await getCollectionByName(col);
    if (c && c.length) allPosts = allPosts.concat(c);
  } catch (err) {
    // Ignore missing collections
  }
}
let tagCount = getCountByTagName(allPosts);
console.log('BtS Tag Count:', tagCount);
let tagArr = getUniqueTags(allPosts);
if (site.asideTagsMaxSize > 0) tagArr = tagArr.slice(0, site.asideTagsMaxSize);
let sortPosts = await sortPostsByDate(allPosts);
let resultPosts = sortPosts.splice(0, site.recentBlogSize);
---

<div class="glass p-4 rounded-lg mb-4">
  {
    tagArr.length > 0 && (
      <div class="aside-widget">
        <i class="ri-hashtag menu-icon" />
        {t('sidebar.tags')}{' '}
        <span class="text-xs opacity-70 ml-auto">[Beyond the Surface]</span>
      </div>
    )
  }
  <div class="flex flex-wrap gap-2">
    {
      tagArr &&
        tagArr.map((tag) => (
          <a
            class="inline-block truncate border px-2 py-1 text-sm rounded-md hover:text-skin-active transition-all duration-300 hover:shadow-sm hover:-translate-y-0.5 hover:border-skin-active"
            title={tag}
            href={getUrl('/beyond-surface/tags/') + tag}
          >
            {tag} <span class="opacity-60">({tagCount[tag]})</span>
          </a>
        ))
    }
    {
      tagArr && site.asideTagsMaxSize > 0 && (
        <a
          class="inline-block truncate m-1 border p-1 text-sm rounded hover:text-skin-active"
          title={t('more')}
          href={getUrl('/beyond-surface/tags')}
        >
          {t('more')} Â»
        </a>
      )
    }
  </div>
</div>

<div class="glass p-4 rounded-lg mb-4">
  <div class="aside-widget">
    <i class="ri-file-line menu-icon"></i>
    {t('sidebar.recentArticle')}
  </div>
  <div class="flex flex-col gap-2">
    {
      resultPosts.map((post) => {
        // Map collection name to display label
        const categoryLabel =
          {
            reflections: '[Reflections]',
            milestones: '[Milestones]',
          }[post.collection] || `[${post.collection}]`;

        return (
          <a
            href={getUrl('/' + post.collection + '/') + post.slug}
            class="truncate cursor-pointer hover:text-skin-active transition-all duration-300 hover:translate-x-1 relative z-10"
            title={post.data.title}
          >
            <span class="opacity-70 mr-1 text-xs">{categoryLabel}</span>
            {post.data.title}
          </a>
        );
      })
    }
  </div>
</div>
