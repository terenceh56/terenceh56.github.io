---
import { getCollectionByName } from '@/utils/getCollectionByName';
import getUniqueTags from '@/utils/getUniqueTags';
import { sortPostsByDate } from '@/utils/sortPostsByDate';
import { site } from '@/consts';
import { t } from '@/i18n/utils';
import getUrl from '@/utils/getUrl';
import getCountByTagName from '@/utils/getCountByTagName';

// Aggregate posts from Beyond the Surface collections ONLY
let allPosts = [];
const collectionsToTry = ['reflections', 'milestones'];
for (const col of collectionsToTry) {
  try {
    const c = await getCollectionByName(col);
    if (c && c.length) allPosts = allPosts.concat(c);
  } catch (err) {
    // Ignore missing collections
  }
}
let tagCount = getCountByTagName(allPosts);
console.log('BtS Tag Count:', tagCount);
let tagArr = getUniqueTags(allPosts);
if (site.asideTagsMaxSize > 0) tagArr = tagArr.slice(0, site.asideTagsMaxSize);
let sortPosts = await sortPostsByDate(allPosts);
let resultPosts = sortPosts.splice(0, site.recentBlogSize);
---

<div class="glass p-4 rounded-lg mb-4">
  {
    tagArr.length > 0 && (
      <div class="aside-widget">
        <i class="ri-hashtag menu-icon" />
        {t('sidebar.tags')} <span class="text-xs opacity-70 ml-auto">[Beyond the Surface]</span>
      </div>
    )
  }
  <div class="flex flex-wrap">
    {
      tagArr &&
        tagArr.map((tag) => (
          <a
            class="inline-block truncate m-1 border p-1 text-sm rounded hover:text-skin-active"
            title={tag}
            href={getUrl('/beyond-surface/tags/') + tag}
          >
            {tag} ({tagCount[tag]})
          </a>
        ))
    }
    {
      tagArr && site.asideTagsMaxSize > 0 && (
        <a
          class="inline-block truncate m-1 border p-1 text-sm rounded hover:text-skin-active"
          title={t('more')}
          href={getUrl('/beyond-surface/tags')}
        >
          {t('more')} Â»
        </a>
      )
    }
  </div>
</div>

<div class="glass p-4 rounded-lg mb-4">
  <div class="aside-widget">
    <i class="ri-file-line menu-icon"></i>
    {t('sidebar.recentArticle')}
  </div>
  <div class="flex flex-col">
    {
      resultPosts.map((post) => (
        <a
          href={getUrl('/' + post.collection + '/') + post.slug}
          class="truncate cursor-pointr mt-1 hover:text-skin-active"
          title={post.data.title}
        >
          {post.data.title}
        </a>
      ))
    }
  </div>
</div>
