---
import CommentAside from '@/components/CommentAside.astro';
import { comment } from '@/consts';
import { getCollectionByName } from '@/utils/getCollectionByName';
import getUniqueTags from '@/utils/getUniqueTags';
import getCountByCategory from '@/utils/getCountByCategory';
import { sortPostsByDate } from '@/utils/sortPostsByDate';
import { site } from '@/consts';
import { t } from '@/i18n/utils';
import getUrl from '@/utils/getUrl';
import getCountByTagName from '@/utils/getCountByTagName';
// Aggregate posts from all collections EXCEPT Beyond the Surface (reflections/milestones)
let allPosts = [];
const collectionsToTry = ['notes', 'papers', 'feed'];
for (const col of collectionsToTry) {
  try {
    const c = await getCollectionByName(col);
    if (c && c.length) allPosts = allPosts.concat(c);
  } catch (err) {
    // Ignore missing collections
  }
}
let tagCount = getCountByTagName(allPosts);
let tagArr = getUniqueTags(allPosts);
if (site.asideTagsMaxSize > 0) tagArr = tagArr.slice(0, site.asideTagsMaxSize);
let categoryCount = getCountByCategory(allPosts);
let sortPosts = await sortPostsByDate(allPosts);
let resultPosts = sortPosts.splice(0, site.recentBlogSize);
---

<!--
<div>
  {
    Object.keys(categoryCount).length > 0 && (
      <div class="aside-widget">
        <i class="ri-folder-3-line menu-icon"/>{t('sidebar.categories')}
      </div>
    )
  }
  {
    Object.keys(categoryCount).map((category) => (
      <a
        class="my-1 truncate block hover:text-skin-active"
        title={category + " (" + categoryCount[category] + ")"}
        href={getUrl("/category/") + category}
      >
        {(category === 'uncategorized' ? t('sidebar.uncategorized') : category) + " (" + categoryCount[category] + ")"}
      </a>
    ))
  }
</div>
-->
<div class="glass p-4 rounded-lg mb-4">
  {
    tagArr.length > 0 && (
      <div class="aside-widget">
        <i class="ri-hashtag menu-icon" />
        {t('sidebar.tags')}{' '}
        <span class="text-xs opacity-70 ml-auto">[Notes]</span>
      </div>
    )
  }
  <div class="flex flex-wrap gap-2">
    {
      tagArr &&
        tagArr.map((tag) => (
          <a
            class="inline-block truncate border px-2 py-1 text-sm rounded-md hover:text-skin-active transition-all duration-300 hover:shadow-sm hover:-translate-y-0.5 hover:border-skin-active"
            title={tag}
            href={getUrl('/tags/') + tag}
          >
            {tag} <span class="opacity-60">({tagCount[tag]})</span>
          </a>
        ))
    }
    {
      tagArr && site.asideTagsMaxSize > 0 && (
        <a
          class="inline-block truncate border px-2 py-1 text-sm rounded-md hover:text-skin-active transition-all duration-300 hover:shadow-sm font-medium"
          title={t('more')}
          href={getUrl('/tags')}
        >
          {t('more')} Â»
        </a>
      )
    }
  </div>
</div>

<div class="glass p-4 rounded-lg mb-4">
  <div class="aside-widget">
    <i class="ri-file-line menu-icon"></i>
    {t('sidebar.recentArticle')}
  </div>
  <div class="flex flex-col gap-1">
    {
      resultPosts.map((post) => {
        // Map collection name to display label
        const categoryLabel =
          {
            notes: '[Notes]',
            papers: '[Papers]',
            feed: '[Feed]',
          }[post.collection] || `[${post.collection}]`;

        return (
          <a
            href={getUrl('/' + post.collection + '/') + post.slug}
            class="flex items-center cursor-pointer hover:text-skin-active transition-all duration-300 hover:translate-x-1 py-2"
            title={post.data.title}
          >
            <span class="opacity-70 mr-1 text-xs flex-shrink-0">
              {categoryLabel}
            </span>
            <span class="truncate">{post.data.title}</span>
          </a>
        );
      })
    }
  </div>

  {comment.enable && comment.type === 'waline' && <CommentAside />}
</div>
