---
import { analytics } from '@/consts';
import { t } from '@/i18n/utils';

const shouldShowCounter = analytics.enable && analytics.busuanzi;
---

{
  shouldShowCounter && (
    <>
      <div
        class="visitor-chip"
        aria-live="polite"
        aria-label="Site traffic"
      >
        <span class="chip-item" id="busuanzi_container_site_pv">
          <i class="ri-eye-line" aria-hidden="true" />
          <span class="chip-label">
            {t('footer.busuanziSitePV')}
          </span>
          <span class="chip-value" id="busuanzi_value_site_pv">--</span>
          {t('footer.busuanziSitePVUnit') && (
            <span class="chip-unit">
              {t('footer.busuanziSitePVUnit')}
            </span>
          )}
        </span>

        <span class="chip-separator">·</span>

        <span class="chip-item" id="busuanzi_container_site_uv">
          <i class="ri-user-line" aria-hidden="true" />
          <span class="chip-label">
            {t('footer.busuanziSiteUV')}
          </span>
          <span class="chip-value" id="busuanzi_value_site_uv">--</span>
          {t('footer.busuanziSiteUVUnit') && (
            <span class="chip-unit">
              {t('footer.busuanziSiteUVUnit')}
            </span>
          )}
        </span>
      </div>

      <script>
        const STORAGE_KEY = 'th_busuanzi_cache';

        const applyCachedValues = () => {
          try {
            const raw = window.localStorage.getItem(STORAGE_KEY);
            if (!raw) return;
            const cache = JSON.parse(raw);
            if (cache && typeof cache === 'object') {
              const pvEl = document.getElementById('busuanzi_value_site_pv');
              const uvEl = document.getElementById('busuanzi_value_site_uv');
              if (pvEl && cache.pv != null) pvEl.textContent = String(cache.pv);
              if (uvEl && cache.uv != null) uvEl.textContent = String(cache.uv);
            }
          } catch {
            // ignore cache errors
          }
        };

        const saveCurrentValuesToCache = () => {
          try {
            const pvEl = document.getElementById('busuanzi_value_site_pv');
            const uvEl = document.getElementById('busuanzi_value_site_uv');
            if (!pvEl || !uvEl) return;

            const pv = pvEl.textContent && pvEl.textContent !== '--' ? pvEl.textContent : null;
            const uv = uvEl.textContent && uvEl.textContent !== '--' ? uvEl.textContent : null;

            if (pv || uv) {
              window.localStorage.setItem(
                STORAGE_KEY,
                JSON.stringify({ pv, uv })
              );
            }
          } catch {
            // ignore storage errors
          }
        };

        const triggerBusuanziFetch = () => {
          const busuanzi = window.BUSUANZI;
          if (busuanzi && typeof busuanzi.fetch === 'function') {
            busuanzi.fetch();
            // give Busuanzi a moment to write numbers, then cache them
            window.setTimeout(saveCurrentValuesToCache, 800);
            return true;
          }
          return false;
        };

        const waitForBusuanzi = () => {
          if (!triggerBusuanziFetch()) {
            window.setTimeout(waitForBusuanzi, 300);
          }
        };

        const initVisitorCounter = () => {
          // show something meaningful immediately if we have it
          applyCachedValues();
          // then keep trying Busuanzi until it’s ready
          waitForBusuanzi();
          document.addEventListener('astro:page-load', () => {
            applyCachedValues();
            waitForBusuanzi();
          });
        };

        if (document.readyState === 'complete' || document.readyState === 'interactive') {
          initVisitorCounter();
        } else {
          document.addEventListener('DOMContentLoaded', initVisitorCounter, { once: true });
        }
      </script>
    </>
  )
}

<style>
  .visitor-chip {
    position: fixed;
    right: 1rem;
    bottom: 1rem;
    z-index: 40;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.35rem 0.75rem;
    border-radius: 999px;
    background: rgba(var(--color-fill), 0.85);
    border: 1px solid rgba(var(--color-text), 0.08);
    color: rgba(var(--color-text), 0.8);
    font-size: 0.78rem;
    line-height: 1;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }

  [data-theme='dark'] .visitor-chip {
    background: rgba(18, 18, 18, 0.85);
    border-color: rgba(255, 255, 255, 0.12);
  }

  .chip-item {
    display: inline-flex;
    align-items: baseline;
    gap: 0.25rem;
    white-space: nowrap;
  }

  .chip-item i {
    font-size: 0.9rem;
    opacity: 0.6;
  }

  .chip-label {
    opacity: 0.7;
  }

  .chip-value {
    font-weight: 600;
    color: rgb(var(--color-text-active));
  }

  .chip-unit {
    opacity: 0.6;
  }

  .chip-separator {
    opacity: 0.4;
  }

  @media (max-width: 768px) {
    .visitor-chip {
      right: 0.75rem;
      bottom: 0.75rem;
      font-size: 0.7rem;
      padding: 0.3rem 0.7rem;
      max-width: calc(100% - 1.5rem);
    }

    .chip-label {
      display: none;
    }
  }
</style>
